<!DOCTYPE html>
<html>
<head>
    <meta charset="ISO-8859-1">
    <title>Product</title>
    <div data-th-replace="Link/CSS :: myCss"></div>
</head>
<body>
<div data-th-replace="/Layout/Sidebar :: mySidebar"></div>
<div class="main-content" id="panel">
    <div data-th-replace="/Layout/Navbar :: myHeader"></div>
    <div class="row">
        <div class="container-fluid " id="container">

            <div class="row mt-5">
                <div class="col-md-2">
                    <div class="card"><h1 class="ml-3">MAKE SALES</h1></div>
                </div>
            </div>
            <div class="row">

                <div class="col-md-12 mt-2">
                   <div class="card">
                       <div class="col-md-6">
                          <div class="row mt-5">
                              <form class="col-md-12" id="sform">
                                 <div class="row">
                                     <div class="col-md-6">
                                         <div class="form-group">
                                                 <label for="pcategory">
                                                     <span>Product category</span>
                                                 </label>
                                                 <select class="form-control" data-toggle="select"  name="pcategor" id="pcategory" required="required">
                                                     <option>Product Category</option>
                                                 </select>
                                         </div>
                                     </div>
                                     <div class="col-md-6">
                                         <div class="form-group">
                                             <div class="">
                                                 <label for="products">
                                                     <span>Products</span>
                                                 </label>
                                                 <select class="form-control" data-toggle="select" name="products" id="products" required="required">
                                                     <option>--Select Products--</option>
                                                 </select>
                                             </div>
                                         </div>
                                     </div>
                                     <div class="col-md-6">
                                         <div class="form-group">
                                             <div >
                                                 <label for="unit">
                                                     <span>UNIT</span>
                                                 </label>
                                                 <input class="form-control text-darker"  type="text" name="unit" id="unit" readonly required="required">
                                             </div>
                                         </div>
                                     </div>
                                     <div class="col-md-6">
                                         <div class="form-group">
                                             <div>
                                                 <label for="quantity">
                                                     <span>Quantity</span>
                                                 </label>
                                                 <input class="form-control" placeholder="Quantity" type="number" name="quantity" id="quantity" required="required">
                                             </div>
                                         </div>
                                     </div>
                                     <div class="col-md-6">
                                         <div class="form-group">
                                             <div >
                                                 <label for="unitPrice">
                                                     <span>Unit price in (Rwf)</span>
                                                 </label>
                                                 <input class="form-control text-darker"  placeholder="unity price" type="number" name="unitPrice" id="unitPrice" required="required" >

                                             </div>
                                         </div>
                                     </div>
                                     <div class="col-md-12">
                                         <div class="form-group">
                                             <div class="input-group input-group-merge">
                                                 <div class="input-group-prepend">
                                                     <span class="input-group-text">Total Price</span>
                                                 </div>
                                                 <input class="form-control text-darker" placeholder="" type="number" id="price" name="price" readonly required="required"  >
                                                 <div class="input-group-append">
                                                     <span class="input-group-text">RWF</span>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                     <div class="col-md-6 mb-2">
                                         <button type="button" class="btn btn-primary" id="saveSales">Make SALES</button>
                                     </div>
                                     <div class="col-md-6 mb-2">
                                         <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">Close</button>
                                     </div>
                                 </div>
                              </form>
                          </div>
                       </div>
                       <div class="col-md-6">

                       </div>
                   </div>
                </div>
            </div>

        </div>
    </div>

</div>


</div>
<div data-th-replace="/Link/Script :: myScript"></div>
<script>

    $(function () {
     findCategory();
     findProduct();

    })

 var products=[]
    function findCategory() {
        $.ajax({
            url: 'products/categories/',
            type: 'GET',
            success:function (data) {
                console.log(data);
                $.each(data.categories, function (i, item) {
                    $('#pcategory').append($('<option>', {
                        value: item.uuid,
                        text : item.name
                    }));
                });
            },
            error:function () {

            }
        })
    }

    function  findProduct() {
        $.ajax({
            url: 'products',
            type: 'GET',
            success:function (data) {
                console.log(data)
                products=data.products;
            },
            error:function () {

            }
        })
    }


    $(document).on("change","#pcategory",function () {
        var category=$(this).val();
        $("#products").empty();

        $.each(products,function (i,item) {
            if(item.category.uuid===category){
                $('#products').append($('<option>', {
                    value: item.uuid,
                    text : item.name
                }));
            }
        })
    })




     $(document).on("keyup","#unitPrice",function () {
         if($("#quantity").val().length>0){
             $("#price").val($(this).val()*$("#quantity").val())
         }
     })

    $(document).on("keyup","#quantity",function () {
        if($("#unitPrice").val().length>0){
            $("#price").val($(this).val()*$("#unitPrice").val())
        }
    })

    $(document).on("change","#products",function () {
        var puuid=$(this)
        $.each( products,function (i,item) {

            if(puuid.val()==item.uuid){
                console.log(puuid.val())
                console.log(item.uuid)
                $("#unit").val(item.unit);
                return;
            }
        })
    })


    $(document).on("click","#saveSales",function(){
        var sales={
            "product":$("#products").val(),
            "unit":$("#unit").val(),
            "quantity":$("#quantity").val(),
            "unitPrice":$("#unitPrice").val(),
            "totalPrice":$("#price").val()
        }
        console.log($("#sform"))
        if($("#sform").valid()){
            $.ajax({
                url: 'sales/create/',
                type: 'POST',
                data: JSON.stringify(sales),
                contentType: 'application/json',
                success:function (data) {
                    console.log(data);
                    if(data.code==200){
                        Swal.fire({
                            type: 'success',
                            title: 'Sales is added successfully',
                            showConfirmButton: false,
                            timer: 1500
                        })
                        setTimeout(()=>{
                            window.location.href="make_sales"
                        },3000)
                    }else{
                        Swal.fire({
                            type: 'error',
                            title: data.msg,
                            showConfirmButton: false,
                            timer: 1500
                        })
                        setTimeout(()=>{
                            window.location.href="make_sales"
                        },3000)
                    }
                },
                error:function () {
                    Swal.fire({
                        type: 'error',
                        title: "Error occured",
                        showConfirmButton: false,
                        timer: 1500
                    })
                }
            })
        }else{
            Swal.fire({
                type: 'error',
                title: "The form is not valid",
                showConfirmButton: false,
                timer: 1500
            })
        }

    })


</script>
</body>
</html>